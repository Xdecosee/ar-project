<!DOCTYPE html>
<html>

<head>
    <title>ARProject</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!-- SCRIPT: three.js library -->
    <script src="https://rawgit.com/mrdoob/three.js/dev/build/three.js"></script>
    <script src="https://cdn.glitch.com/64df24d4-c4fc-476b-9208-9c076af8be32%2Fthree.min.js?1508448492664"></script>
    <!-- SCRIPT: jsartookit -->
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/vendor/jsartoolkit5/build/artoolkit.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/vendor/jsartoolkit5/js/artoolkit.api.js"></script>
    <!-- SCRIPT: include threex.artoolkit -->
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/src/threex/threex-artoolkitsource.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/src/threex/threex-artoolkitcontext.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/src/threex/threex-arbasecontrols.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/src/threex/threex-armarkercontrols.js"></script>
    <script src="https://rawgit.com/dataarts/dat.gui/master/build/dat.gui.min.js"></script>
    <link rel="stylesheet" href="/style.css">

</head>

<body style="margin : 0px; overflow: hidden; font-family: Monospace;">

    <script src="https://rawgit.com/socketio/socket.io-client/master/dist/socket.io.js"></script>
    <script src="https://rawgit.com/mrdoob/three.js/master/examples/js/renderers/CSS3DRenderer.js"></script>
    <script>
        ///Section: Variables

        //Variables - Important Variables
        var onRenderFcts = [];
        var scene = new THREE.Scene();
        var camera = new THREE.Camera();
        var renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
        });
        var lastTimeMsec = null;

        //Variables - Crow Logo
        var crowMap = new THREE.TextureLoader().load("https://cdn.glitch.com/64df24d4-c4fc-476b-9208-9c076af8be32%2Fcrow-logo.png?1508448491892");
        var crowMaterial = new THREE.SpriteMaterial({
            map: crowMap,
            color: 0xffffff
        });
        var crowLogo = new THREE.Sprite(crowMaterial);

        //Variables - Action Text
        var textMesh, loader, textGeo;
        var textUrl = 'https://cdn.glitch.com/0a2baf12-9f45-4a89-9513-4cd98cd5ec2a%2Fhelvetiker_regular.typeface.json?1509508427145';

        var textMat = new THREE.MeshBasicMaterial({
            color: 0xFFFFFF,

        });
        var textDef = " ";
        var textCont = new THREE.Group;

        //Variables - Curve Path
        var path, counter = 0;
        var tangent = new THREE.Vector3();
        var axis = new THREE.Vector3();
        var up = new THREE.Vector3(0, 1, 0);
        var numPoints = 50;

        //Variables - Curve Line (Derived from Curve Path)
        var curveLineMat = new THREE.LineBasicMaterial({
            color: 0x000000,
            opacity: 0.0
        });
        var curveLineGeo = new THREE.Geometry();
        var curveLine = new THREE.Line(curveLineGeo, curveLineMat);

        //Variables - AR Markers and their Pointers
        var controls3, controls5;
        var marker3 = new THREE.Group;
        var marker5 = new THREE.Group;
        var midpoint = new THREE.Vector3();
        var manager = new THREE.LoadingManager();
        var portalUrl = ' https://cdn.glitch.com/0a2baf12-9f45-4a89-9513-4cd98cd5ec2a%2Fportal.json?1509609972673';

        //Variables - View
        var sphereZone = new THREE.Group;
        var queueZone = new THREE.Group;
        var mInfoZone = new THREE.Group;

        //Variables - Display of Spheres(Attack/Defense)
        var sphere;
        var queue = [];
        var firstItem = [];
        var defaultGeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
        var defaultMat = new THREE.MeshBasicMaterial({
            color: 0xFFFFFF,

        });

        //Vairables - RealTime & Controls for User
        var socket = io();
        var machineArr = [];
        var gui = new dat.GUI({
            autoPlace: false
        });
        var guiDiv = document.createElement('div');
        var markerVals = [];
        var destSph, srcSph;
        var start = marker5;
        var end = marker3;

        //Variables- CSS3drenderer
        var scene2 = new THREE.Scene();
        var renderer2 = new THREE.CSS3DRenderer();

        //Variables - Machine Info(Two Markers)
        var blueText = "Blue Team";
        var redText = "Red Team";
        var elementsArr = [];


        // renderer.domElement.style.top = '0px'
        //  renderer.domElement.style.left = '0px';
        guiDiv.style.position = 'absolute';
        // guiDiv.style.left = '0px';
        guiDiv.style.zIndex = 10;
        guiDiv.style.top = '0px'
        document.body.appendChild(guiDiv);
        guiDiv.appendChild(gui.domElement);

        ///Section: WEBGLRENDERER
        renderer.setClearColor(new THREE.Color('lightgrey'), 0)
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.style.position = 'absolute'
        // renderer.domElement.style.top = '0px'
        renderer.domElement.style.left = '0px';
        document.body.appendChild(renderer.domElement);

        ///Section: Css3drenderer
        renderer2.setSize(window.innerWidth, window.innerHeight);
        renderer2.domElement.style.position = 'absolute';
        //renderer2.domElement.style.top = 0;
        renderer.domElement.style.left = '0px';
        document.body.appendChild(renderer2.domElement);

        //Actually no need trackball controls 
        // controls = new THREE.TrackballControls(camera, renderer.domElement);
        scene.add(camera);

        ///Section: ARTOOLKITSOURCE
        var arToolkitSource = new THREEx.ArToolkitSource({
            sourceType: 'webcam',
        })
        arToolkitSource.init(function onReady() {
            onResize()
        })
        window.addEventListener('resize', function() {
            onResize()
        })

        function onResize() {
            arToolkitSource.onResizeElement()
            arToolkitSource.copyElementSizeTo(renderer.domElement)
            if (arToolkitContext.arController !== null) {
                arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
            }
        }

        ///Section: ARTOOLKITCONTEXT
        var arToolkitContext = new THREEx.ArToolkitContext({
            cameraParametersUrl: 'https://cdn.glitch.com/64df24d4-c4fc-476b-9208-9c076af8be32%2Fcamera_para.dat?1508448491282',
            detectionMode: 'mono_and_matrix',
            matrixCodeType: '3x3'
        })
        arToolkitContext.init(function onCompleted() {

            camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
        })
        onRenderFcts.push(function() {
            if (arToolkitSource.ready === false) return
            arToolkitContext.update(arToolkitSource.domElement)
        })

        ///Section: Dat.GUI
        var FizzyText = function() {
            this.View = function() {};
            this.Info = function() {};
        };

        var text = new FizzyText();
        gui.add(text, 'View').name('Switch View');
        gui.add(text, 'Info').name('More Info');
      
        ///Section: Sphere Queue
        var queueDiv = document.createElement('div');
        var queueTable = document.createElement("TABLE");
        var queueObj = new THREE.CSS3DObject(queueDiv);

      
        function popFromQueue() {

            if (queue.length > 0) {
                firstItem = queue[0];

                if (sphere.visible == false) {
                    sphere.geometry = firstItem[0];
                    sphere.material = firstItem[1];
                    queue.shift();
                    sphere.visible = true;

                    if (marker3.visible === true && marker5.visible === true) {

                        loader = new THREE.FontLoader().load(textUrl, function(font) {
                            loadText(firstItem[2], firstItem[1], font);
                        });
                        start = firstItem[3];
                        end = firstItem[4];

                        var itemRow = document.createElement("TR");
                        var actCell = document.createElement("TD");
                        var actText = document.createTextNode(firstItem[2]);
                        var timeCell = document.createElement("TD");
                        var timeText = document.createTextNode(firstItem[5]);
                        queueTable.appendChild(itemRow);
                        actCell.appendChild(actText);
                        itemRow.appendChild(actCell);
                        timeCell.appendChild(timeText);
                        itemRow.appendChild(timeCell);
                        setColour(actCell, null);
                        setColour(timeCell, null);

                    }

                }
            }

        }

        function pushToQueue(type, begin, finish, dateTime) {
            var newgeo;
            var newmat;
            var newText;
            if (type == 1) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x00FF00,
                });

                newText = "Normal";

            } else if (type == 2) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFFFF00,
                });
                newText = "Reconnaissance";

            } else if (type == 3) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFFA500,
                });

                newText = "SQL Injection";
            } else if (type == 4) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFF69B4,
                });
                newText = "Semantic URL Attack";

            } else if (type == 5) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x800080,

                });
                newText = "Command Injection";

            } else if (type == 6) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x00FFFF,

                });

                newText = "Remote Code Execution";

            } else if (type == 7) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xA52A2A,

                });

                newText = "URL Manipulation";

            } else if (type == 8) {
                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x000080,

                });

                newText = "Privilege Escalation";

            } else if (type == 9) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xff0000,

                });

                newText = "Directory Traversal Attack";

            } else if (type == 10) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x006400,

                });

                newText = "defense1";

            } else if (type == 11) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x808080,

                });

                newText = "defense2";

            } else if (type == 12) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFFB6C1,

                });

                newText = "defense3";

            } else {
                newgeo = new THREE.SphereGeometry(0, 0, 0);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFFFFFF,

                });

                newText = "Error";

            }

            queue.push([newgeo, newmat, newText, begin, finish, dateTime]);

        }

        ///Section: SPHERE MOVING ON CURVE
        function moveSphere() {

            if (sphere.visible == true) {

                if (counter <= 1) {

                    sphere.position.copy(path.getPointAt(counter));

                    tangent = path.getTangentAt(counter).normalize();

                    axis.crossVectors(up, tangent).normalize();

                    var radians = Math.acos(up.dot(tangent));

                    sphere.quaternion.setFromAxisAngle(axis, radians);

                    counter += 0.005
                } else {
                    counter = 0;
                    sphere.visible = false;
                    loader = new THREE.FontLoader().load(textUrl, function(font) {
                        loadText(textDef, textMat, font);
                    });

                }

            }

        }

        ///Section: Pointers(Portals) For Blue & Red
        function bluePointer(group) {

            var blueLight = new THREE.DirectionalLight(0x444444);
            blueLight.position.set(0, 0, 1).normalize();
            scene.add(blueLight);

            var loader = new THREE.ObjectLoader().load(portalUrl,

                function(obj) {

                    var newcolor = new THREE.MeshPhongMaterial({
                        color: 0x3C3CFF
                    });

                    function paint(o3d) {
                        var children = o3d.children,
                            geometry = o3d.geometry;
                        for (var i = 0, il = children.length; i < il; i++) {
                            paint(children[i]);
                        }
                        if (geometry) o3d.material = newcolor;

                    }

                    paint(obj);
                    obj.rotation.set(0, 4, 0);
                    group.add(obj);
                    blueLight.target = obj;

                },
            );

        };

        function redPointer(group) {

            var redLight = new THREE.DirectionalLight(0x444444);
            redLight.position.set(0, 0, 1).normalize();
            scene.add(redLight);

            var loader = new THREE.ObjectLoader().load(portalUrl,

                function(obj) {

                    var newcolor = new THREE.MeshPhongMaterial({
                        color: 0xff0000
                    });

                    function paint(o3d) {
                        var children = o3d.children,
                            geometry = o3d.geometry;
                        for (var i = 0, il = children.length; i < il; i++) {
                            paint(children[i]);
                        }
                        if (geometry) o3d.material = newcolor;

                    }

                    paint(obj);
                    obj.rotation.set(0, 4, 0);
                    group.add(obj);
                    redLight.target = obj;

                },
            );

        }

        ///Section: Load Action Type Text
        function loadText(text, mat, font) {
            textGeo = new THREE.TextGeometry(text, {
                font: font,
                size: 2,
                height: 1,
            });
            textMesh.geometry = textGeo;
            textMesh.material = mat;
        }

        ///Section: 'Getters'
        function getVal(ip) {

            for (var i = 0; i < machineArr.length; i++) {
                if (ip == machineArr[i].ip) {
                    return machineArr[i].value;
                }
            }

        }

        function getHostName(ip) {
            for (var i = 0; i < machineArr.length; i++) {
                if (ip == machineArr[i].ip) {
                    return machineArr[i].hostname;
                }
            }
        }

        function getGrp(val) {

            for (var i = 0; i < markerVals.length; i++) {

                if (val == markerVals[i][0]) {
                    return markerVals[i][1];

                }

            }

        }

        function getIp(barcode) {

            for (var i = 0; i < machineArr.length; i++) {

                if (barcode == machineArr[i].value) {

                    return machineArr[i].ip;
                }

            }
        }
           
        function getElement(grp, index) {

          
            var barcode, element;
            for (var i = 0; i < elementsArr.length; i++) {

                for (var j = 0; j < markerVals.length; j++) {

                    if (markerVals[j][1] == grp) {
                        barcode = markerVals[j][0];

                    }
                }

                if (elementsArr[i][0] == barcode) {
                    element = elementsArr[i][index];
                    return element;
                }
            }

        }
        
        ///Section: Div for Each Machine
        function setColour(element, team) {

            element.style.borderCollapse = "collapse";
            element.style.textAlign = "center";

            if (team == blueText) {

                element.style.border = "3px solid blue";
                element.style.background = "aqua";

            } else if (team == redText) {

                element.style.border = "3px solid red";
                element.style.background = "#f08080";

            } else {
                element.style.border = "3px solid white";
                element.style.background = "black";
                element.style.color = "white";

            }

        }

        function createTable(barcode, team, ip, hostname) {

            var div = document.createElement('div');
            var table = document.createElement("TABLE");
            var obj = new THREE.CSS3DObject(div);

            div.style.width = '100px';
            div.style.height = '100px';
            div.style.visibility = "hidden";
            div.appendChild(table);
            obj.scale.set(0.01, 0.01, 0.01);
            scene2.add(obj);
            //Header - Machine Team
            var teamRow = document.createElement("TR");
            var teamHead = document.createElement("TH");
            var teamText, displayedText;

            if (team == 0) {

                teamText = document.createTextNode(blueText);
                displayedText = blueText;
            } else {
                teamText = document.createTextNode(redText);
                displayedText = redText;

            }

            table.appendChild(teamRow);
            teamHead.setAttribute("colspan", "2");
            teamHead.appendChild(teamText);
            teamRow.appendChild(teamHead);

            var ipRow = document.createElement("TR");
            var ipHead = document.createElement("TD");
            var ipText = document.createTextNode(ip);
            table.appendChild(ipRow);
            ipHead.setAttribute("colspan", "2");
            ipHead.appendChild(ipText);
            ipRow.appendChild(ipHead);
            //Second Row - Machine HostName
            var hostRow = document.createElement("TR");
            var hostHead = document.createElement("TD");
            var hostText = document.createTextNode(hostname);
            table.appendChild(hostRow);
            hostHead.setAttribute("colspan", "2");
            hostHead.appendChild(hostText);
            hostRow.appendChild(hostHead);

            setColour(table, displayedText);
            setColour(teamHead, displayedText);
            setColour(ipHead, displayedText);
            setColour(hostHead, displayedText);
            elementsArr.push([barcode, div, table, obj]);

        }
        
        ///Section: Div Visibility & Position
        function setPosVis(div, obj, grp) {
            div.style.visibility = "visible";
            obj.position.set(grp.position.x, grp.position.y, grp.position.z);
        }
        
      ;(function() {


            /// Section: generate Markers (HardCode)
            scene.add(marker3);
            controls3 = new THREEx.ArMarkerControls(arToolkitContext, marker3, {
                type: 'barcode',
                barcodeValue: 3
            })
            markerVals.push([controls3.parameters.barcodeValue, controls3.object3d]);
            bluePointer(marker3);
        

            scene.add(marker5);
            controls5 = new THREEx.ArMarkerControls(arToolkitContext, marker5, {
                type: 'barcode',
                barcodeValue: 5

            })
            markerVals.push([controls5.parameters.barcodeValue, controls5.object3d]);
            redPointer(marker5);
       
        
            socket.on('machines', function(machines) {

                //What happens if got new machine ???
                for (var i = 0; i < machines.length; i++) {

                    machineArr[i] = machines[i];
                    createTable(machines[i].value, machines[i].team, machines[i].ip, machines[i].hostname);

                }

            });

        })()
   
        
        
      
      ;(function() {
            
            ///Section: Queue Table
            queueDiv.style.width = '100px';
            queueDiv.style.height = '100px';
            queueDiv.style.visibility = "hidden";
            queueDiv.appendChild(queueTable);
            queueObj.scale.set(0.01, 0.01, 0.01);
            scene2.add(queueObj);
            var queueRow = document.createElement("TR");
            queueTable.appendChild(queueRow);
            var actionHead = document.createElement("TH");
            var actionText = document.createTextNode("Action");
            actionHead.appendChild(actionText);
            var dateHead = document.createElement("TH");
            var dateText = document.createTextNode("Time");
            dateHead.appendChild(dateText);
            queueRow.appendChild(actionHead);
            queueRow.appendChild(dateHead);
            setColour(queueTable, null);
            setColour(actionHead, null);
            setColour(dateHead, null);

            ///Section: Socket.io stuff
            socket.on('action', function(sphere) {
                srcSph = sphere.o.src;
                destSph = sphere.o.dest;

                var srcVal = getVal(srcSph);
                var destVal = getVal(destSph);

                var begin = getGrp(srcVal);
                var finish = getGrp(destVal);

                if (begin.visible === true && finish.visible === true) {
                    pushToQueue(sphere.o.actionType, begin, finish, sphere.o.dateTime);
                }

            });

            /// Section: CROW LOGO
            crowMap.minFilter = THREE.LinearFilter
            crowLogo.scale.set(1, 0.40, 1);

            /// Section : SPHERE OBJ
            sphere = new THREE.Mesh(defaultGeo, defaultMat);
            sphereZone.add(sphere);
            sphere.visible = false;
            setInterval(moveSphere, 10);

            ///Section: Loading Action Type Text
            manager.onProgress = function(item, loaded, total) {

                console.log(item, loaded, total);

            }
            loader = new THREE.FontLoader().load(textUrl, function(font) {
                textGeo = new THREE.TextGeometry(textDef, {
                    font: font,
                    size: 2,
                    height: 1,
                });

                textMesh = new THREE.Mesh(textGeo, textMat);
                sphereZone.add(textMesh);
            });

            /// Section: SphereZone
            scene.add(sphereZone);

            onRenderFcts.push(function() {
                popFromQueue();

                //Two Markers Visible
                if (marker3.visible === true && marker5.visible === true) {

                  

                    ///Section: Update Midpoint Value
                    midpoint.addVectors(marker3.position, marker5.position).multiplyScalar(1 / 2)
                    midpoint.y += 1;
                    
                    ///Section: CSS3D (HardCode)
                    setPosVis(getElement(marker3, 1), getElement(marker3, 3), marker3);
                    setPosVis(getElement(marker5, 1), getElement(marker5, 3), marker5);
                  
                  
                    queueDiv.style.visibility = "visible";
                    queueObj.position.set(midpoint.x, midpoint.y, midpoint.z);

                    ///Section: CROW LOGO
                    crowLogo.position.set(midpoint.x, midpoint.y, midpoint.z);
                    crowLogo.position.y += 0.30;

                    ///Section: CURVE STUFF
                    path = new THREE.QuadraticBezierCurve3(
                        start.position,
                        midpoint,
                        end.position

                    );
                    curvePoints = path.getPoints(numPoints);
                    curveLineGeo = curveLine.geometry;
                    for (var i = 0; i < curvePoints.length; i++) {
                        curveLineGeo.vertices[i] = curvePoints[i];

                    }
                    curveLineGeo.verticesNeedUpdate = true;

                    ///Section: Action Type Text
                    textMesh.geometry.center();
                    textMesh.scale.set(0.05, 0.05, 0.05);
                    textMesh.position.set(midpoint.x, midpoint.y, midpoint.z);

                    ///Section: SphereZone
                    sphereZone.add(curveLine);
                    sphereZone.add(crowLogo);
                    sphereZone.visible = true;

                    //One Marker Visible
                } else if (marker3.visible === true || marker5.visible === true) {

                    sphereZone.visible = false;
                    queue = [];

                    //No Markers Visible
                } else {

                    sphereZone.visible = false;
                    queue = [];

                }
            })
        })()

        /// Section: Render the scene
        onRenderFcts.push(function() {
            renderer.render(scene, camera);

        })

        ///Section: Run the rendering loop
        requestAnimationFrame(function animate(nowMsec) {

            //  controls.update();
            renderer2.render(scene2, camera);
            requestAnimationFrame(animate);
            lastTimeMsec = lastTimeMsec || nowMsec - 1000 / 60
            var deltaMsec = Math.min(200, nowMsec - lastTimeMsec)
            lastTimeMsec = nowMsec
            onRenderFcts.forEach(function(onRenderFct) {
                onRenderFct(deltaMsec / 1000, nowMsec / 1000)
            })

        })
    </script>

    <script src="https://code.jquery.com/jquery-2.2.1.min.js" integrity="sha256-gvQgAFzTH6trSrAWoH1iPo9Xc96QxSZ3feW6kem+O00=" crossorigin="anonymous"></script>

</body>

</html>