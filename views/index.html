<!DOCTYPE html>
<html>

<head>
    <title>ARProject</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!-- SCRIPT: three.js library -->
    <script src="https://rawgit.com/mrdoob/three.js/dev/build/three.js"></script>
    <script src="https://cdn.glitch.com/64df24d4-c4fc-476b-9208-9c076af8be32%2Fthree.min.js?1508448492664"></script>
    <!-- SCRIPT: jsartookit -->
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/vendor/jsartoolkit5/build/artoolkit.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/vendor/jsartoolkit5/js/artoolkit.api.js"></script>
    <!-- SCRIPT: include threex.artoolkit -->
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/src/threex/threex-artoolkitsource.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/src/threex/threex-artoolkitcontext.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/src/threex/threex-arbasecontrols.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/three.js/src/threex/threex-armarkercontrols.js"></script>
    <script src="https://rawgit.com/dataarts/dat.gui/master/build/dat.gui.min.js"></script>
    <link rel="stylesheet" href="/style.css">

    <script src="https://code.jquery.com/jquery-2.2.1.min.js" integrity="sha256-gvQgAFzTH6trSrAWoH1iPo9Xc96QxSZ3feW6kem+O00=" crossorigin="anonymous"></script>

</head>

<body style="margin : 0px; overflow: hidden; font-family: Monospace;" onload="threadsLoad()">

    <script src="https://rawgit.com/socketio/socket.io-client/master/dist/socket.io.js"></script>
    <script src="https://rawgit.com/mrdoob/three.js/master/examples/js/renderers/CSS3DRenderer.js"></script>
    <script src="https://rawgit.com/jeromeetienne/threex.windowresize/master/threex.windowresize.js"></script>
    <script>
        ///Section: Variables
        //Variables - Important Variables
        var onRenderFcts = [];
        var scene = new THREE.Scene();
         
        var renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
        });
        var lastTimeMsec = null;
        var camera = new THREE.PerspectiveCamera(42, window.innerWidth / window.innerHeight, 0.1, 100);	

        //Variables - Crow Logo
        var crowMap = new THREE.TextureLoader().load("https://cdn.glitch.com/64df24d4-c4fc-476b-9208-9c076af8be32%2Fcrow-logo.png?1508448491892");
        var crowMaterial = new THREE.SpriteMaterial({
            map: crowMap,
            color: 0xffffff
        });
        var crowLogo = new THREE.Sprite(crowMaterial);

        //Variables - Action Text
        var textMesh, loader, textGeo;
        var textUrl = 'https://cdn.glitch.com/0a2baf12-9f45-4a89-9513-4cd98cd5ec2a%2Fhelvetiker_regular.typeface.json?1509508427145';

        var textMat = new THREE.MeshBasicMaterial({
            color: 0xFFFFFF,

        });
        var textDef = " ";
        var textCont = new THREE.Group;

        //Variables - Curve Path
        var tangent = new THREE.Vector3();
        var axis = new THREE.Vector3();
        var up = new THREE.Vector3(0, 1, 0);

        //Variables - AR Markers and their Pointers
        var controls3, controls5;
        var marker3 = new THREE.Group;
        var marker5 = new THREE.Group;
        var midpoint = new THREE.Vector3();
        var manager = new THREE.LoadingManager();
        var portalUrl = 'https://cdn.glitch.com/0a2baf12-9f45-4a89-9513-4cd98cd5ec2a%2Fplane-with-holes.json?1510708506074';

        //Variables - View
        var sphereZone = new THREE.Group;
        var queueZone = new THREE.Group;
        var mInfoZone = new THREE.Group;

        //Variables - Display of Spheres(Attack/Defense)
        var defaultGeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
        var defaultMat = new THREE.MeshBasicMaterial({
            color: 0xFFFFFF
        });

        //Vairables - RealTime & Controls for User
        var socket = io();
        var machineArr = [];
        var gui = new dat.GUI({
            autoPlace: false
        });
        var guiDiv = document.createElement('div');
        var markerVals = [];
        var destSph, srcSph;
        var start = marker5;
        var end = marker3;

        //Variables- CSS3drenderer
        var scene2 = new THREE.Scene();
        var renderer2 = new THREE.CSS3DRenderer();

        //Variables - Machine Info(Two Markers)
        var blueText = "Blue Team";
        var redText = "Red Team";
        var elementsArr = [];
        var visibleT = false;
        var previousType = null;
        var doubleEmptyRows = [];
        var doubleVis = [];
        var testOne, testTwo, doubleData, doubleMatch, grpOne, grpTwo, twoIndex, groupOne, groupTwo;
        var firstMarker, secondMarker, index;
        var midAdd = [];

        //Variables - Machine Info (One Marker)
        var singleElementsArr = [];
        var textNodeArr = [];
        var singleVis = [];
        var singleEmptyRows = [];
        var testThree, singleData, singleMatch, grpThree, oneIndex, groupThree;

        //Variables - MultiPaths
        var pathVar = [];
        var counter1 = 0;
        var counter2 = 0;
        var counter3 = 0;
        var availPath = 0 ;  
        var thread1, thread2, thread3,pathMaxIndex, selectedPath;
    
        guiDiv.style.position = 'absolute';
        guiDiv.style.zIndex = 10;
        guiDiv.style.top = '0px'
        document.body.appendChild(guiDiv);
        guiDiv.appendChild(gui.domElement);

        ///Section: Get Available Machines From DB
        $(function() {

            $.get('/machines', function(machines) {

                for (var i = 0; i < machines.length; i++) {
                    machineArr[i] = machines[i];
                }

            });

        });

        ///Section: WEBGLRENDERER
        renderer.setClearColor(new THREE.Color('lightgrey'), 0)
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.style.position = 'absolute'
        renderer.domElement.style.left = '0px';
        document.body.appendChild(renderer.domElement);
        var winResize	= new THREEx.WindowResize(renderer, camera)

        ///Section: Css3drenderer
        renderer2.setSize(window.innerWidth, window.innerHeight);
        renderer2.domElement.style.position = 'absolute';
        renderer.domElement.style.left = '0px';
        document.body.appendChild(renderer2.domElement);
        var winResize	= new THREEx.WindowResize(renderer2, camera)

        scene.add(camera);

        ///Section: ARTOOLKITSOURCE
        var arToolkitSource = new THREEx.ArToolkitSource({
            sourceType: 'webcam',
        })
        arToolkitSource.init(function onReady() {
            onResize()
        })
        window.addEventListener('resize', function() {
            onResize()
               
        })

        function onResize() {
            arToolkitSource.onResizeElement()
            arToolkitSource.copyElementSizeTo(renderer.domElement)
            if (arToolkitContext.arController !== null) {
                arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
            }
        }

        ///Section: ARTOOLKITCONTEXT
        var arToolkitContext = new THREEx.ArToolkitContext({
            cameraParametersUrl: 'https://cdn.glitch.com/64df24d4-c4fc-476b-9208-9c076af8be32%2Fcamera_para.dat?1508448491282',
            detectionMode: 'mono_and_matrix',
            matrixCodeType: '3x3'
        })
        arToolkitContext.init(function onCompleted() {

            camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
        })
        onRenderFcts.push(function() {
            if (arToolkitSource.ready === false) return
            arToolkitContext.update(arToolkitSource.domElement)
        })

        ///Section: Dat.GUI
        var FizzyText = function() {
            this.Info = false;
        };
        var text = new FizzyText();
        var controls = gui.add(text, 'Info').name('More Info').listen().onChange(function(newValue) {

            if (visibleT == false) {
                visibleT = true;
            } else {
                visibleT = false;
            }

        });

        ///Section: Create Divs Needed
        var queueDiv = document.createElement('div');
        var queueTable = document.createElement("TABLE");
        var queueObj = new THREE.CSS3DObject(queueDiv);
        var singleDiv = document.createElement('div');
        var singleTable = document.createElement("TABLE");
        var singleObj = new THREE.CSS3DObject(singleDiv);

        ///Section: Sphere Queue
        function genArrTwo(newText, dateTime, source) {

            var data = [];
            data.push(newText);
            data.push(dateTime);
            data.push(source);
            return data;

        }

        function genArrOne(direction, ip, action, time) {
            var data = [];
            data.push(direction);
            data.push(ip);
            data.push(action);
            data.push(time);

            return data;
        }

        function queueElement(type, begin, finish) {
            var newgeo;
            var newmat;
            var newText;
            var newData = [];

            if (type == 1) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x00FF00,
                });

                newText = "Normal";

            } else if (type == 2) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFFFF00,
                });
                newText = "Reconnaissance";

            } else if (type == 3) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFFA500,
                });

                newText = "SQL Injection";
            } else if (type == 4) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFF69B4,
                });
                newText = "Semantic URL Attack";

            } else if (type == 5) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x800080,

                });
                newText = "Command Injection";

            } else if (type == 6) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x00FFFF,

                });

                newText = "Remote Code Execution";

            } else if (type == 7) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xA52A2A,

                });

                newText = "URL Manipulation";

            } else if (type == 8) {
                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x000080,

                });

                newText = "Privilege Escalation";

            } else if (type == 9) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xff0000,

                });

                newText = "Directory Traversal Attack";

            } else if (type == 10) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x006400,

                });

                newText = "defense1";

            } else if (type == 11) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0x808080,

                });

                newText = "defense2";

            } else if (type == 12) {

                newgeo = new THREE.SphereGeometry(0.1, 0.64, 0.64);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFFB6C1,

                });

                newText = "defense3";

            } else {
                newgeo = new THREE.SphereGeometry(0, 0, 0);
                newmat = new THREE.MeshBasicMaterial({
                    color: 0xFFFFFF,

                });

                newText = "Error";

            }

            newData.push(newgeo);
            newData.push(newmat);
            newData.push(newText);
            newData.push(begin);
            newData.push(finish);
            return newData;

        }

     
        ///Section: Pointers(Portals) For Blue & Red
        function bluePointer(group) {

            var blueLight = new THREE.DirectionalLight(0x444444);
            blueLight.position.set(0, 0, 1).normalize();
            scene.add(blueLight);

            var loader = new THREE.ObjectLoader().load(portalUrl,

                function(obj) {

                    var newcolor = new THREE.MeshPhongMaterial({
                        color: 0x3C3CFF,
                      polygonOffset: true,
                     polygonOffsetFactor:-4,
                      depthWrite:false
                    });

                    function paint(o3d) {
                        var children = o3d.children,
                            geometry = o3d.geometry;
                        for (var i = 0, il = children.length; i < il; i++) {
                            paint(children[i]);
                        }
                        if (geometry) o3d.material = newcolor;

                    }

                    paint(obj);
                    group.add(obj);
                obj.scale.set(0.8,0.8,0.8);
                    blueLight.target = obj;

                },
            );

        };
      
        function redPointer(group) {

            var redLight = new THREE.DirectionalLight(0x444444);
            redLight.position.set(0, 0, 1).normalize();
            scene.add(redLight);

            var loader = new THREE.ObjectLoader().load(portalUrl,

                function(obj) {

                    var newcolor = new THREE.MeshPhongMaterial({
                        color: 0xff0000,
                       polygonOffset: true,
                    polygonOffsetFactor:-4,
                    depthWrite:false
                    });

                    function paint(o3d) {
                        var children = o3d.children,
                            geometry = o3d.geometry;
                        for (var i = 0, il = children.length; i < il; i++) {
                            paint(children[i]);
                        }
                        if (geometry) o3d.material = newcolor;

                    }

                    paint(obj);
                    group.add(obj);
                   obj.scale.set(0.8,0.8,0.8);
                    redLight.target = obj;

                },
            );

        }

        ///Section: Load Action Type Text
        function loadText(text, mat, font) {
            textGeo = new THREE.TextGeometry(text, {
                font: font,
                size: 2,
                height: 1,
            });
            textMesh.geometry = textGeo;
            textMesh.material = mat;
        }

        ///Section: 'Getters'
        function getVal(ip) {

            for (var i = 0; i < machineArr.length; i++) {
                if (ip == machineArr[i].ip) {
                    return machineArr[i].value;
                }
            }

        }

        function getTeamVal(ip) {

            for (var i = 0; i < machineArr.length; i++) {
                if (ip == machineArr[i].ip) {
                    return machineArr[i].team;
                }
            }

        }

        function getGrp(val) {

            for (var i = 0; i < markerVals.length; i++) {

                if (val == markerVals[i][0]) {
                    return markerVals[i][1];

                }

            }

        }

        function getIp(barcode) {

            for (var i = 0; i < machineArr.length; i++) {

                if (barcode == machineArr[i].value) {

                    return machineArr[i].ip;
                }

            }
        }

        function getHost(barcode) {
            for (var i = 0; i < machineArr.length; i++) {

                if (barcode == machineArr[i].value) {

                    return machineArr[i].hostname;
                }

            }
        }

        function getTeam(barcode) {
            for (var i = 0; i < machineArr.length; i++) {

                if (barcode == machineArr[i].value) {

                    return machineArr[i].team;
                }

            }
        }

        function getValue(grp) {

            for (var i = 0; i < markerVals.length; i++) {

                if (grp == markerVals[i][1]) {
                    return markerVals[i][0];

                }

            }

        }

        ///Section: Div for Each Machine
        function setColour(element, team) {

            element.style.borderCollapse = "collapse";
            element.style.textAlign = "center";
            element.style.color = "white";

            if (team == blueText) {

                element.style.border = "2px solid white";
                element.style.background = "#000099";

            } else if (team == redText) {

                element.style.border = "2px solid white";
                element.style.background = "#B20000";

            } else {
                element.style.border = "2px solid white";
                element.style.background = "black";

            }

        }

        function createRows(text) {

            //Header - Machine Team
            var teamRow = document.createElement("TR");
            var teamHead = document.createElement("TH");
            var teamText, displayedText;
            teamText = document.createTextNode(text);
            displayedText = text;

            queueTable.appendChild(teamRow);
            teamHead.appendChild(teamText);
            teamRow.appendChild(teamHead);

            var ipHead = document.createElement("TD");
            teamRow.appendChild(ipHead);
            var hostHead = document.createElement("TD");
            teamRow.appendChild(hostHead);
            setColour(teamHead, displayedText);
            setColour(ipHead, displayedText);
            setColour(hostHead, displayedText);
            var ipText = document.createTextNode(" ");
            var hostText = document.createTextNode(" ");
            ipHead.appendChild(ipText);
            hostHead.appendChild(hostText);

            elementsArr.push([ipText, hostText, text]);

        }

        ///Section: Div Visibility & Position
        function twoPosVis() {

            queueDiv.style.visibility = "visible";
            queueObj.position.set(midpoint.x, midpoint.y, midpoint.z);
            queueObj.position.z += -5;

        }

        function onePosVis(marker) {

            singleDiv.style.visibility = "visible";
            singleObj.position.set(marker.position.x, marker.position.y, marker.position.z);
            singleObj.position.z += -5;
            singleObj.position.y += 1.3;

        }

        function hideTable(div, obj) {

            div.style.visibility = "hidden";
            obj.position.set(0, 0, 0);

        }

        ///Section: Update Ip & Hostname
        function appendData(group) {

            var barcode = getValue(group);
            var ip = getIp(barcode);
            var host = getHost(barcode);
            var team = getTeam(barcode);

            for (var i = 0; i < elementsArr.length; i++) {

                if (team == 0 && elementsArr[i][2] == blueText || team == 1 && elementsArr[i][2] == redText) {

                    elementsArr[i][0].nodeValue = ip;
                    elementsArr[i][1].nodeValue = host;

                }

            }

            return group;

        }

        //UPon Detection of one marker
        function fillElements(marker) {

            var text;
            var barcode = getValue(marker);
            var team = getTeam(barcode);

            if (team == 0) {
                text = blueText;

            } else if (team == 1) {
                text = redText;
            }

            for (var i = 0; i < singleElementsArr.length; i++) {

                setColour(singleElementsArr[i], text);
            }

            textNodeArr[0].nodeValue = text;
            textNodeArr[1].nodeValue = getIp(barcode);
            textNodeArr[2].nodeValue = getHost(barcode);

            return marker;

        }

        function createSingle() {

            singleDiv.appendChild(singleTable);
            singleDiv.style.width = '150px';
            singleDiv.style.height = '150px';
            singleDiv.style.visibility = "hidden";
            singleObj.scale.set(0.01, 0.01, 0.01);
            scene2.add(singleObj);

            emptyRow(singleTable);

            var rowHeaders = document.createElement("TR");
            singleTable.appendChild(rowHeaders);

            var directionHead = document.createElement("TH");
            var directionText = document.createTextNode("Direction");
            directionHead.appendChild(directionText);
            rowHeaders.appendChild(directionHead);
            setColour(directionHead, null);

            var ipHead = document.createElement("TH");
            var ipText = document.createTextNode("IP");
            ipHead.appendChild(ipText);
            rowHeaders.appendChild(ipHead);
            setColour(ipHead, null);

            var actionHead = document.createElement("TH");
            var actionText = document.createTextNode("Action");
            actionHead.appendChild(actionText);
            rowHeaders.appendChild(actionHead);
            setColour(actionHead, null);

            var dateHead = document.createElement("TH");
            var dateText = document.createTextNode("Time");
            dateHead.appendChild(dateText);
            rowHeaders.appendChild(dateHead);
            setColour(dateHead, null);

            doubleEmpty(singleTable);

        }

        function createDouble() {

            queueDiv.style.width = '150px';
            queueDiv.style.height = '150px';
            queueDiv.style.visibility = "hidden";
            queueDiv.appendChild(queueTable);
            queueObj.scale.set(0.01, 0.01, 0.01);
            scene2.add(queueObj);
            createRows(blueText);
            createRows(redText);
            var queueRow = document.createElement("TR");
            queueTable.appendChild(queueRow);
            var actionHead = document.createElement("TH");
            var actionText = document.createTextNode("Action");
            actionHead.appendChild(actionText);
            var dateHead = document.createElement("TH");
            var dateText = document.createTextNode("Time");
            dateHead.appendChild(dateText);
            var sourceHead = document.createElement("TH");
            var sourceText = document.createTextNode("Source");
            sourceHead.appendChild(sourceText);
            queueRow.appendChild(actionHead);
            queueRow.appendChild(dateHead);
            queueRow.appendChild(sourceHead);
            setColour(actionHead, null);
            setColour(dateHead, null);
            setColour(sourceHead, null);
            doubleEmpty(queueTable);

        }

        function emptyRow(table) {

            var emptyRow, emptyCell, emptyNode;
            emptyRow = document.createElement("TR");
            table.appendChild(emptyRow);

            for (var j = 0; j < 3; j++) {

                emptyCell = document.createElement("TD");
                emptyRow.appendChild(emptyCell);
                singleElementsArr.push(emptyCell);
                emptyNode = document.createTextNode(" ");
                emptyCell.appendChild(emptyNode);
                textNodeArr.push(emptyNode);

            }

        }

        function doubleEmpty(table) {
            var noOfCells, emptyCon;

            if (table == queueTable) {
                noOfCells = 3;
                emptyCon = doubleEmptyRows;
            } else if (table == singleTable) {
                noOfCells = 4;
                emptyCon = singleEmptyRows;
            }
            for (var i = 0; i < 3; i++) {
                var itemRow = document.createElement("TR");
                var rowArr = [];

                for (var j = 0; j < noOfCells; j++) {
                    var cell = document.createElement("TD");
                    itemRow.appendChild(cell);
                    var node = document.createTextNode(" ");
                    cell.appendChild(node);
                    setColour(cell, null);
                    rowArr.push(node);

                }
                table.appendChild(itemRow);
                emptyCon.push(rowArr);

            }
        }

        function singleEmptyPush(group, dateTime, action, ip, direction) {

            for (var i = 0; i < singleVis.length; i++) {
                testThree = singleVis[i][0];

                if (testThree == group) {
                    singleData = genArrOne(direction, ip, action, dateTime);

                    if (singleVis[i].length == 4) {
                        singleVis[i].splice(1, 1);
                    }

                    singleVis[i].push(singleData);
                }

            }

        }

        function singleEmptyPop(group) {

            for (var i = 0; i < singleVis.length; i++) {

                grpThree = singleVis[i][0];

                if (grpThree == group) {

                    singleMatch = singleVis[i];
                    for (var j = 1; j < singleMatch.length; j++) {
                        oneIndex = j - 1;

                        singleEmptyRows[oneIndex][0].nodeValue = singleMatch[j][0];
                        singleEmptyRows[oneIndex][1].nodeValue = singleMatch[j][1];
                        singleEmptyRows[oneIndex][2].nodeValue = singleMatch[j][2];
                        singleEmptyRows[oneIndex][3].nodeValue = singleMatch[j][3];

                    }

                }

            }
        }
        
  
        function threadsLoad(){
          
                   thread1= setInterval(function(){
                     
                       moveSphere1(pathVar[0][0], pathVar[0][1]);
                    }, 10);
                    
                   
            
              
                   thread2 = setInterval(function(){
                     moveSphere2(pathVar[1][0], pathVar[1][1]);
                   }, 10);
              
          
                    thread3 = setInterval(function(){
              
                 
                     moveSphere3(pathVar[2][0], pathVar[2][1]);
                   }, 10);
       
         
        }
      
    
           ///Section: SPHERE MOVING ON CURVE
        function moveSphere1(path, sphere) {
           
            if (sphere.visible == true) {
                 
                if (counter1 <= 1) {

                    sphere.position.copy(path.getPointAt(counter1));

                    tangent = path.getTangentAt(counter1).normalize();

                    axis.crossVectors(up, tangent).normalize();

                    var radians = Math.acos(up.dot(tangent));

                    sphere.quaternion.setFromAxisAngle(axis, radians);

                    counter1 += 0.005
                } else {
                    counter1 = 0;
                    sphere.visible = false;
                    loader = new THREE.FontLoader().load(textUrl, function(font) {
                        loadText(textDef, textMat, font);
                    });

                }

            }

        }

      
         ///Section: SPHERE MOVING ON CURVE
        function moveSphere2(path, sphere) {
            
            if (sphere.visible == true) {
                
                if (counter2 <= 1) {

                    sphere.position.copy(path.getPointAt(counter2));

                    tangent = path.getTangentAt(counter2).normalize();

                    axis.crossVectors(up, tangent).normalize();

                    var radians = Math.acos(up.dot(tangent));

                    sphere.quaternion.setFromAxisAngle(axis, radians);

                    counter2 += 0.005
  
                } else {
                    counter2 = 0;
                    sphere.visible = false;
                    loader = new THREE.FontLoader().load(textUrl, function(font) {
                        loadText(textDef, textMat, font);
                    });

                }

            }

        }

         ///Section: SPHERE MOVING ON CURVE
        function moveSphere3(path, sphere) {
           
            if (sphere.visible == true) {
                
                if (counter3 <= 1) {

                    sphere.position.copy(path.getPointAt(counter3));

                    tangent = path.getTangentAt(counter3).normalize();

                    axis.crossVectors(up, tangent).normalize();

                    var radians = Math.acos(up.dot(tangent));

                    sphere.quaternion.setFromAxisAngle(axis, radians);

                    counter3 += 0.005
                } else {
                    counter3 = 0;
                    sphere.visible = false;
                    loader = new THREE.FontLoader().load(textUrl, function(font) {
                        loadText(textDef, textMat, font);
                    });

                }

            }

        }

        function popFromQueue() {
          var firstItem, queue, sphere, startVector, endVector;
          var midVector = new THREE.Vector3();
          for(var i = 0; i < pathVar.length; i++){
               
              if(pathVar[i][2].length > 0 ){
                
         
                queue = pathVar[i][2];
                firstItem = queue[0];
                sphere = pathVar[i][1];
                path = pathVar[i][0];
                val = pathVar[i][3];
               
                 midVector.addVectors(firstItem[3].position, firstItem[4].position).multiplyScalar(1 / 2);
                  midVector.y += val;
             
                
                if (sphere.visible == false) {
                
                  sphere.geometry = firstItem[0];
                  sphere.material = firstItem[1];
               
               
                
                  if (firstItem[3].visible === true && firstItem[4].visible === true) {
                       
                    pathVar[i][0] = new THREE.QuadraticBezierCurve3(
                         firstItem[3].position,
                          midVector,
                          firstItem[4].position
                      );
                  
                    
                    sphere.visible = true;
                  
                    loader = new THREE.FontLoader().load(textUrl, function(font) {
                          loadText(firstItem[2], firstItem[1], font);
                    });
                  
                    queue.shift();
                  }
                  
                  
                }
                
              }
            
          }

              

          

      }

        function initPathVar(){
            
            var el1 = createPathEl(1.9, 1);
            var el2 = createPathEl(1.3, 2);
            var el3 = createPathEl(0.6, 3);
           
            pathVar.push(el1);
            pathVar.push(el2);
            pathVar.push(el3);
            
        
            pathMaxIndex = pathVar.length - 1;
          
          
        }
        function createPathEl(val, id){
          
            var el = [];
            var path;
            var newSphere = new THREE.Mesh(defaultGeo, defaultMat);
            sphereZone.add(newSphere);
            newSphere.visible = false;
            var queue = [];
            newSphere.scale.set(0.8,0.8,0.8);
            el = [path, newSphere, queue, val];
           
            return el;
          
        }
        
          
       
        function getQueue(){
          
         
          if(availPath > pathMaxIndex){
        
             availPath = 0;
         
          }
          
          selectedPath = availPath;
          availPath++;
          return pathVar[selectedPath][2];
          
        }
      
        function emptyQueue(){
          
          for(var i = 0 ; i < pathVar.length; i++){
            
            pathVar[i][2] = [];
            
          }
          
        }
              
      ;(function() {
            ///Section: CSS3D - One Marker
            createDouble();
            createSingle();

            /// Section: generate Markers (HardCode)
            scene.add(marker3);
            controls3 = new THREEx.ArMarkerControls(arToolkitContext, marker3, {
                type: 'barcode',
                barcodeValue: 3
            })
            markerVals.push([controls3.parameters.barcodeValue, controls3.object3d]);
            bluePointer(marker3);

            scene.add(marker5);
            controls5 = new THREEx.ArMarkerControls(arToolkitContext, marker5, {
                type: 'barcode',
                barcodeValue: 5

            })
            markerVals.push([controls5.parameters.barcodeValue, controls5.object3d]);
            redPointer(marker5);

            for (var i = 0; i < markerVals.length; i++) {
                var doubleArr = [];
                var singleArr = [];

                firstMarker = markerVals[i][1];
                index = i + 1;

                for (var j = index; j < markerVals.length; j++) {
                    secondMarker = markerVals[j][1];
                    doubleArr.push(firstMarker, secondMarker);
                    doubleVis.push(doubleArr);
                }
                singleArr.push(firstMarker);
                singleVis.push(singleArr);
            }

        })()
           
       
       ;(function() {
            
            ///Section: Socket.io stuff
            socket.on('action', function(sphere) {
                
             
                if (sphere.o.actionType != previousType) {
                    srcSph = sphere.o.src;
                    destSph = sphere.o.dest;

                    var srcVal = getVal(srcSph);
                    var destVal = getVal(destSph);

                    var srcTeam = getTeamVal(srcSph);

                    var begin = getGrp(srcVal);
                    var finish = getGrp(destVal);

                    var teamValue, element, queue;
                    if (srcTeam == 0) {
                        teamValue = blueText;
                    } else {
                        teamValue = redText;
                    }
                    
                  
                    element = queueElement(sphere.o.actionType, begin, finish);
                   
                    for (var i = 0; i < doubleVis.length; i++) {
                        testOne = doubleVis[i][0];
                        testTwo = doubleVis[i][1];
                        if ((testOne == begin && testTwo == finish) || (testOne == finish && testTwo == begin)) {

                            doubleData = genArrTwo(element[2], sphere.o.dateTime, teamValue);

                            if (doubleVis[i].length == 5) {
                                doubleVis[i].splice(2, 1);
                            }

                            doubleVis[i].push(doubleData);

                        }
                    }

                    singleEmptyPush(begin, sphere.o.dateTime, element[2], destSph, "Outbound");
                    singleEmptyPush(finish, sphere.o.dateTime, element[2], srcSph, "Inbound");
                    
                    
                    if (begin.visible === true && finish.visible === true) {
                        
                        queue = getQueue();
                        queue.push(element);
                        

                    }

                    previousType = sphere.o.actionType;
                }
            });

            /// Section: CROW LOGO
            crowMap.minFilter = THREE.LinearFilter
            crowLogo.scale.set(1, 0.40, 1);

            /// Section : SPHERE OBJ
            initPathVar();
         
            ///Section: Loading Action Type Text
            manager.onProgress = function(item, loaded, total) {

                console.log(item, loaded, total);

            }
            loader = new THREE.FontLoader().load(textUrl, function(font) {
                textGeo = new THREE.TextGeometry(textDef, {
                    font: font,
                    size: 2,
                    height: 1,
                });

                textMesh = new THREE.Mesh(textGeo, textMat);
                sphereZone.add(textMesh);
            });

            /// Section: SphereZone
            scene.add(sphereZone);

            onRenderFcts.push(function() {
                popFromQueue();

                //Two Markers Visible
                if (marker3.visible === true && marker5.visible === true) {

                    ///Section: Update Midpoint Value
                    midpoint.addVectors(marker3.position, marker5.position).multiplyScalar(1 / 2)
                    midpoint.y += 1;

                    ///Section: CROW LOGO
                    crowLogo.position.set(midpoint.x, midpoint.y, midpoint.z);
                    crowLogo.position.y += 0.30;

                    ///Section: CSS3D - Two Markers (HardCode)
                    if (visibleT == true) {
                        groupOne = appendData(marker3);
                        groupTwo = appendData(marker5);
                        twoPosVis();

                        for (var i = 0; i < doubleVis.length; i++) {

                            grpOne = doubleVis[i][0];
                            grpTwo = doubleVis[i][1];

                            if ((grpOne == groupOne && grpTwo == groupTwo) || (grpOne == groupTwo && grpTwo == groupOne)) {
                                doubleMatch = doubleVis[i];
                                for (var j = 2; j < doubleMatch.length; j++) {
                                    twoIndex = j - 2;

                                    doubleEmptyRows[twoIndex][0].nodeValue = doubleMatch[j][0];
                                    doubleEmptyRows[twoIndex][1].nodeValue = doubleMatch[j][1];
                                    doubleEmptyRows[twoIndex][2].nodeValue = doubleMatch[j][2];

                                }

                            }

                        }
                    } else {
                        hideTable(queueDiv, queueObj);
                    }
                    hideTable(singleDiv, singleObj);
                  
                    ///Section: Action Type Text
                    textMesh.geometry.center();
                    textMesh.scale.set(0.05, 0.05, 0.05);
                    textMesh.position.set(midpoint.x, midpoint.y, midpoint.z);

                    ///Section: SphereZone
                    sphereZone.add(crowLogo);
                    sphereZone.visible = true;

                    //One Marker Visible
                } else if (marker3.visible === true) {

                    if (visibleT == true) {
                        onePosVis(marker3);
                        groupThree = fillElements(marker3);
                        singleEmptyPop(groupThree);

                    } else {
                        hideTable(singleDiv, singleObj);
                    }

                    sphereZone.visible = false;
                    emptyQueue();
                    hideTable(queueDiv, queueObj);

                } else if (marker5.visible === true) {

                    if (visibleT == true) {
                        onePosVis(marker5);
                        groupThree = fillElements(marker5);
                        singleEmptyPop(groupThree);
                    } else {
                        hideTable(singleDiv, singleObj);
                    }

                    sphereZone.visible = false;
                    emptyQueue();
                    hideTable(queueDiv, queueObj);

                    //No Markers Visible
                } else {

                    sphereZone.visible = false;
                    emptyQueue();
                    hideTable(queueDiv, queueObj);
                    hideTable(singleDiv, singleObj);

                }
            })
        })()

        /// Section: Render the scene
        onRenderFcts.push(function() {
            renderer.render(scene, camera);

        })

        ///Section: Run the rendering loop
        requestAnimationFrame(function animate(nowMsec) {
            renderer2.render(scene2, camera);
            requestAnimationFrame(animate);
            lastTimeMsec = lastTimeMsec || nowMsec - 1000 / 60
            var deltaMsec = Math.min(200, nowMsec - lastTimeMsec)
            lastTimeMsec = nowMsec
            onRenderFcts.forEach(function(onRenderFct) {
                onRenderFct(deltaMsec / 1000, nowMsec / 1000)
            })

        })
    </script>

</body>

</html>